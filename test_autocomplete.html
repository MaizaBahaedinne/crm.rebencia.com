<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Autocomplétion</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .dropdown { position: absolute; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; width: 300px; }
        .dropdown-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown-item:hover { background-color: #f5f5f5; }
        .loading { color: #666; font-style: italic; padding: 10px; }
        #result { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Autocomplétion Agences et Agents</h1>
    
    <div class="form-group">
        <label for="agencyInput">Agence :</label>
        <div style="position: relative;">
            <input type="text" id="agencyInput" placeholder="Tapez pour rechercher une agence...">
            <div id="agencyDropdown" class="dropdown" style="display: none;"></div>
        </div>
        <input type="hidden" id="agencyId" value="">
    </div>
    
    <div class="form-group">
        <label for="agentInput">Agent :</label>
        <div style="position: relative;">
            <input type="text" id="agentInput" placeholder="Sélectionnez d'abord une agence..." disabled>
            <div id="agentDropdown" class="dropdown" style="display: none;"></div>
            <div id="agentLoading" class="loading" style="display: none;">Chargement des agents...</div>
        </div>
        <input type="hidden" id="agentId" value="">
    </div>
    
    <div id="result">
        <h3>Sélection :</h3>
        <p><strong>Agence :</strong> <span id="selectedAgency">Aucune</span></p>
        <p><strong>Agent :</strong> <span id="selectedAgent">Aucun</span></p>
    </div>

    <script>
        let agencySearchTimeout;
        let agentSearchTimeout;
        let currentAgencyId = null;
        let userContext = null;
        
        // Éléments DOM
        const agencyInput = document.getElementById('agencyInput');
        const agencyDropdown = document.getElementById('agencyDropdown');
        const agencyId = document.getElementById('agencyId');
        const agentInput = document.getElementById('agentInput');
        const agentDropdown = document.getElementById('agentDropdown');
        const agentLoading = document.getElementById('agentLoading');
        const agentId = document.getElementById('agentId');
        const selectedAgency = document.getElementById('selectedAgency');
        const selectedAgent = document.getElementById('selectedAgent');
        
        // Charger le contexte utilisateur au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadUserContext();
        });
        
        function loadUserContext() {
            fetch('/crm.rebencia.com/test_direct.php?action=user_context')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        userContext = data.context;
                        setupFormBasedOnRole();
                    } else {
                        console.error('Impossible de charger le contexte utilisateur');
                        // Mode par défaut (admin)
                        setupDefaultForm();
                    }
                })
                .catch(error => {
                    console.error('Erreur contexte:', error);
                    setupDefaultForm();
                });
        }
        
        function setupFormBasedOnRole() {
            const permissions = userContext.permissions;
            
            // Afficher le contexte utilisateur
            const roleInfo = document.createElement('div');
            roleInfo.style.cssText = 'background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 20px;';
            roleInfo.innerHTML = `
                <h3>Contexte Utilisateur</h3>
                <p><strong>Rôle:</strong> ${userContext.role} ${userContext.is_admin ? '(Admin)' : ''}</p>
                <p><strong>Permissions:</strong> ${permissions.description}</p>
            `;
            document.body.insertBefore(roleInfo, document.querySelector('h1').nextSibling);
            
            // Configurer les champs selon les permissions
            if (permissions.auto_fill_agency) {
                agencyInput.value = permissions.agency_name;
                agencyId.value = permissions.agency_id;
                currentAgencyId = permissions.agency_id;
                agencyInput.disabled = true;
                agencyInput.style.backgroundColor = '#f5f5f5';
                selectedAgency.textContent = permissions.agency_name;
                
                if (permissions.auto_fill_agent) {
                    // Agent : remplissage automatique
                    agentInput.value = permissions.agent_name;
                    agentId.value = permissions.agent_id;
                    agentInput.disabled = true;
                    agentInput.style.backgroundColor = '#f5f5f5';
                    selectedAgent.textContent = permissions.agent_name;
                } else {
                    // Manager : peut choisir ses agents
                    agentInput.disabled = false;
                    agentInput.placeholder = 'Choisissez un agent de votre équipe...';
                    loadAgentsByAgency(currentAgencyId);
                }
            } else if (!permissions.can_choose_agency) {
                agencyInput.disabled = true;
                agencyInput.placeholder = 'Accès agence restreint';
            }
        }
        
        function setupDefaultForm() {
            // Configuration par défaut (admin ou utilisateur standard)
            agencyInput.placeholder = 'Tapez pour rechercher une agence...';
            agentInput.placeholder = 'Sélectionnez d\'abord une agence...';
        }
        
        // Autocomplétion des agences (seulement si autorisé)
        agencyInput.addEventListener('input', function() {
            if (userContext && !userContext.permissions.can_choose_agency) {
                return; // Bloqué pour les non-admin/non-standard
            }
            
            const query = this.value.trim();
            
            clearTimeout(agencySearchTimeout);
            
            if (query.length < 2) {
                agencyDropdown.style.display = 'none';
                return;
            }
            
            agencySearchTimeout = setTimeout(() => {
                searchAgencies(query);
            }, 300);
        });
        
        // Autocomplétion des agents (selon les permissions)
        agentInput.addEventListener('input', function() {
            if (userContext && !userContext.permissions.can_choose_agent) {
                return; // Bloqué pour les agents
            }
            
            const query = this.value.trim();
            
            clearTimeout(agentSearchTimeout);
            
            if (!currentAgencyId) {
                return;
            }
            
            if (query.length < 2) {
                loadAgentsByAgency(currentAgencyId);
                return;
            }
            
            agentSearchTimeout = setTimeout(() => {
                searchAgentsByAgency(currentAgencyId, query);
            }, 300);
        });
        
        function searchAgencies(query) {
            fetch('/crm.rebencia.com/test_direct.php?action=agencies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'query=' + encodeURIComponent(query)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.agencies) {
                    showAgencyDropdown(data.agencies);
                } else {
                    agencyDropdown.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erreur recherche agences:', error);
                agencyDropdown.style.display = 'none';
            });
        }
        
        function showAgencyDropdown(agencies) {
            agencyDropdown.innerHTML = '';
            
            agencies.forEach(agency => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = agency.display || agency.name;
                item.onclick = function() {
                    selectAgency(agency);
                };
                agencyDropdown.appendChild(item);
            });
            
            agencyDropdown.style.display = 'block';
        }
        
        function selectAgency(agency) {
            agencyInput.value = agency.name;
            agencyId.value = agency.id;
            currentAgencyId = agency.id;
            agencyDropdown.style.display = 'none';
            selectedAgency.textContent = agency.name;
            
            // Activer le champ agent
            agentInput.disabled = false;
            agentInput.placeholder = 'Tapez pour rechercher un agent...';
            
            // Charger les agents
            loadAgentsByAgency(agency.id);
        }
        
        function loadAgentsByAgency(agencyId) {
            searchAgentsByAgency(agencyId, '');
        }
        
        function searchAgentsByAgency(agencyId, query = '') {
            agentLoading.style.display = 'block';
            
            fetch('/crm.rebencia.com/test_direct.php?action=agents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'agency_id=' + encodeURIComponent(agencyId) + '&query=' + encodeURIComponent(query)
            })
            .then(response => response.json())
            .then(data => {
                agentLoading.style.display = 'none';
                
                if (data.success && data.agents) {
                    showAgentDropdown(data.agents);
                } else {
                    console.error('Erreur agents:', data.message);
                    agentDropdown.style.display = 'none';
                }
            })
            .catch(error => {
                agentLoading.style.display = 'none';
                console.error('Erreur recherche agents:', error);
                agentDropdown.style.display = 'none';
            });
        }
        
        function showAgentDropdown(agents) {
            agentDropdown.innerHTML = '';
            
            if (agents.length === 0) {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = 'Aucun agent trouvé';
                agentDropdown.appendChild(item);
            } else {
                agents.forEach(agent => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = agent.display || agent.name;
                    item.onclick = function() {
                        selectAgent(agent);
                    };
                    agentDropdown.appendChild(item);
                });
            }
            
            agentDropdown.style.display = 'block';
        }
        
        function selectAgent(agent) {
            agentInput.value = agent.name;
            agentId.value = agent.id;
            agentDropdown.style.display = 'none';
            selectedAgent.textContent = agent.name;
        }
        
        // Fermer les dropdowns si on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!agencyInput.contains(e.target) && !agencyDropdown.contains(e.target)) {
                agencyDropdown.style.display = 'none';
            }
            if (!agentInput.contains(e.target) && !agentDropdown.contains(e.target)) {
                agentDropdown.style.display = 'none';
            }
        });
    </script>
</body>
</html>
