<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Intégration BaseController</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between mb-4">
                    <h4 class="mb-sm-0">Test Intégration BaseController</h4>
                    <div id="user-context-info" class="text-end">
                        <small id="connection-status" class="text-muted">Vérification...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context User Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Contexte Utilisateur Connecté</h5>
                    </div>
                    <div class="card-body">
                        <div id="user-context-display" class="row">
                            <!-- Sera rempli par JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulaire Client Adaptatif -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Nouveau Client</h5>
                        <p class="text-muted mb-0">Formulaire adaptatif selon le rôle utilisateur</p>
                    </div>
                    <div class="card-body">
                        <form id="clientForm">
                            <div class="row">
                                <!-- Informations de base -->
                                <div class="col-lg-6 mb-3">
                                    <label for="nom" class="form-label">Nom *</label>
                                    <input type="text" class="form-control" id="nom" name="nom" required>
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label for="prenom" class="form-label">Prénom *</label>
                                    <input type="text" class="form-control" id="prenom" name="prenom" required>
                                </div>
                                
                                <!-- Agence - Adaptatif selon rôle -->
                                <div class="col-lg-6 mb-3">
                                    <label for="agency_id" class="form-label">
                                        Agence *
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Sélection selon votre rôle"></i>
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="agency_search" placeholder="Tapez pour rechercher une agence..." autocomplete="off">
                                        <input type="hidden" id="agency_id" name="agency_id">
                                        <div id="agency_results" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
                                    </div>
                                    <small class="text-muted" id="agency-help">Recherche dans toutes les agences</small>
                                </div>
                                
                                <!-- Agent - Adaptatif selon rôle -->
                                <div class="col-lg-6 mb-3">
                                    <label for="agent_id" class="form-label">
                                        Agent Responsable *
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Agent selon votre rôle"></i>
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="agent_search" placeholder="Tapez pour rechercher un agent..." autocomplete="off">
                                        <input type="hidden" id="agent_id" name="agent_id">
                                        <div id="agent_results" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
                                    </div>
                                    <small class="text-muted" id="agent-help">Recherche selon votre agence</small>
                                </div>

                                <!-- Email et Téléphone -->
                                <div class="col-lg-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                                <div class="col-lg-6 mb-3">
                                    <label for="telephone" class="form-label">Téléphone</label>
                                    <input type="tel" class="form-control" id="telephone" name="telephone">
                                </div>

                                <!-- Type de client -->
                                <div class="col-lg-6 mb-3">
                                    <label for="type_client" class="form-label">Type de Client</label>
                                    <select class="form-select" id="type_client" name="type_client">
                                        <option value="">Sélectionner...</option>
                                        <option value="acheteur">Acheteur</option>
                                        <option value="vendeur">Vendeur</option>
                                        <option value="locataire">Locataire</option>
                                        <option value="propriétaire">Propriétaire</option>
                                        <option value="investisseur">Investisseur</option>
                                    </select>
                                </div>

                                <!-- Source -->
                                <div class="col-lg-6 mb-3">
                                    <label for="source" class="form-label">Source</label>
                                    <select class="form-select" id="source" name="source">
                                        <option value="">Sélectionner...</option>
                                        <option value="site_web">Site Web</option>
                                        <option value="recommandation">Recommandation</option>
                                        <option value="publicite">Publicité</option>
                                        <option value="evenement">Événement</option>
                                        <option value="autre">Autre</option>
                                    </select>
                                </div>

                                <!-- Adresse -->
                                <div class="col-12 mb-3">
                                    <label for="adresse" class="form-label">Adresse</label>
                                    <textarea class="form-control" id="adresse" name="adresse" rows="2"></textarea>
                                </div>

                                <!-- Notes -->
                                <div class="col-12 mb-3">
                                    <label for="notes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-secondary me-2">Annuler</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Panel Debug - Contexte Temps Réel</h6>
                    </div>
                    <div class="card-body">
                        <div id="debug-info">
                            <pre id="debug-content" class="bg-light p-3 rounded" style="font-size: 12px; max-height: 300px; overflow-y: auto;">Chargement du contexte...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let userContext = null;
        let currentTimeout = null;
        
        // Initialiser l'interface
        document.addEventListener('DOMContentLoaded', function() {
            loadUserContext();
            setupFormEventListeners();
            initializeTooltips();
        });

        function initializeTooltips() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        function loadUserContext() {
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Récupération contexte...';
            
            fetch('./client/get_user_context')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        userContext = data.context;
                        displayUserContext(userContext);
                        adaptFormToContext(userContext);
                        updateDebugInfo(userContext);
                        document.getElementById('connection-status').innerHTML = '<i class="fas fa-check-circle text-success"></i> Connecté';
                    } else {
                        throw new Error(data.error || 'Erreur inconnue');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erreur';
                    document.getElementById('debug-content').textContent = 'Erreur: ' + error.message;
                });
        }

        function displayUserContext(context) {
            const display = document.getElementById('user-context-display');
            const agent = context.agent_info;
            
            display.innerHTML = `
                <div class="col-md-4">
                    <h6 class="text-primary">Utilisateur</h6>
                    <p><strong>Nom:</strong> ${context.name || 'N/A'}<br>
                    <strong>Rôle:</strong> <span class="badge bg-${getRoleBadgeClass(context.role)}">${context.role_text || context.role}</span><br>
                    <strong>Admin:</strong> ${context.is_admin ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-muted"></i>'}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-info">Agent Info</h6>
                    <p><strong>Agent:</strong> ${agent?.agent_name || 'Aucun'}<br>
                    <strong>Agence:</strong> ${agent?.agency_name || 'Aucune'}<br>
                    <strong>Position:</strong> ${agent?.position || 'N/A'}</p>
                </div>
                <div class="col-md-4">
                    <h6 class="text-success">Permissions</h6>
                    <p class="small">${context.permissions.description}</p>
                    <div class="small">
                        ${context.permissions.can_choose_agency ? '<span class="badge bg-success">Choix agence</span>' : '<span class="badge bg-secondary">Agence fixe</span>'}
                        ${context.permissions.can_choose_agent ? '<span class="badge bg-success">Choix agent</span>' : '<span class="badge bg-secondary">Agent fixe</span>'}
                    </div>
                </div>
            `;
        }

        function getRoleBadgeClass(role) {
            switch(role?.toLowerCase()) {
                case 'admin': return 'danger';
                case 'manager': return 'warning';
                case 'agent': return 'info';
                default: return 'secondary';
            }
        }

        function adaptFormToContext(context) {
            const permissions = context.permissions;
            
            // Adapter le champ agence
            const agencySearch = document.getElementById('agency_search');
            const agencyHelp = document.getElementById('agency-help');
            
            if (permissions.auto_fill_agency) {
                agencySearch.value = permissions.agency_name || '';
                document.getElementById('agency_id').value = permissions.agency_id || '';
                agencySearch.readOnly = true;
                agencySearch.classList.add('bg-light');
                agencyHelp.textContent = 'Agence pré-remplie selon votre profil';
            } else if (!permissions.can_choose_agency) {
                agencySearch.placeholder = 'Aucune agence disponible';
                agencySearch.disabled = true;
                agencyHelp.textContent = 'Pas d\'autorisation pour choisir une agence';
            } else {
                agencyHelp.textContent = 'Recherche dans toutes les agences disponibles';
            }
            
            // Adapter le champ agent
            const agentSearch = document.getElementById('agent_search');
            const agentHelp = document.getElementById('agent-help');
            
            if (permissions.auto_fill_agent) {
                agentSearch.value = permissions.agent_name || context.name || '';
                document.getElementById('agent_id').value = permissions.agent_id || context.user_id || '';
                agentSearch.readOnly = true;
                agentSearch.classList.add('bg-light');
                agentHelp.textContent = 'Agent pré-rempli (vous-même)';
            } else if (!permissions.can_choose_agent) {
                agentSearch.placeholder = 'Aucun agent disponible';
                agentSearch.disabled = true;
                agentHelp.textContent = 'Pas d\'autorisation pour choisir un agent';
            } else {
                agentHelp.textContent = permissions.agency_id ? 'Recherche dans votre agence uniquement' : 'Recherche dans tous les agents';
            }
        }

        function setupFormEventListeners() {
            // Autocomplétion agence
            document.getElementById('agency_search').addEventListener('input', function(e) {
                if (this.readOnly) return;
                
                if (currentTimeout) clearTimeout(currentTimeout);
                currentTimeout = setTimeout(() => {
                    searchAgencies(this.value);
                }, 300);
            });

            // Autocomplétion agent
            document.getElementById('agent_search').addEventListener('input', function(e) {
                if (this.readOnly) return;
                
                if (currentTimeout) clearTimeout(currentTimeout);
                currentTimeout = setTimeout(() => {
                    searchAgents(this.value);
                }, 300);
            });

            // Cacher les résultats en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.position-relative')) {
                    document.getElementById('agency_results').classList.remove('show');
                    document.getElementById('agent_results').classList.remove('show');
                }
            });
        }

        function searchAgencies(term) {
            if (term.length < 2) {
                document.getElementById('agency_results').classList.remove('show');
                return;
            }

            fetch(`./client/search_agencies_from_crm?term=${encodeURIComponent(term)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.agencies) {
                        displayAgencyResults(data.agencies);
                    }
                })
                .catch(error => console.error('Erreur recherche agences:', error));
        }

        function searchAgents(term) {
            if (term.length < 2) {
                document.getElementById('agent_results').classList.remove('show');
                return;
            }

            const agencyId = document.getElementById('agency_id').value;
            let url = `./client/search_agents_from_crm?term=${encodeURIComponent(term)}`;
            if (agencyId) {
                url += `&agency_id=${agencyId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.agents) {
                        displayAgentResults(data.agents);
                    }
                })
                .catch(error => console.error('Erreur recherche agents:', error));
        }

        function displayAgencyResults(agencies) {
            const resultsDiv = document.getElementById('agency_results');
            
            if (agencies.length === 0) {
                resultsDiv.innerHTML = '<div class="dropdown-item-text text-muted">Aucune agence trouvée</div>';
            } else {
                resultsDiv.innerHTML = agencies.map(agency => 
                    `<a class="dropdown-item" href="#" data-id="${agency.ID}" data-name="${agency.post_title}">
                        <div class="d-flex justify-content-between">
                            <span>${agency.post_title}</span>
                            <small class="text-muted">${agency.agent_count || 0} agents</small>
                        </div>
                    </a>`
                ).join('');
                
                // Event listeners pour les clics
                resultsDiv.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.getElementById('agency_search').value = this.dataset.name;
                        document.getElementById('agency_id').value = this.dataset.id;
                        resultsDiv.classList.remove('show');
                        
                        // Reset agent si une nouvelle agence est sélectionnée
                        document.getElementById('agent_search').value = '';
                        document.getElementById('agent_id').value = '';
                    });
                });
            }
            
            resultsDiv.classList.add('show');
        }

        function displayAgentResults(agents) {
            const resultsDiv = document.getElementById('agent_results');
            
            if (agents.length === 0) {
                resultsDiv.innerHTML = '<div class="dropdown-item-text text-muted">Aucun agent trouvé</div>';
            } else {
                resultsDiv.innerHTML = agents.map(agent => 
                    `<a class="dropdown-item" href="#" data-id="${agent.ID}" data-name="${agent.post_title}">
                        <div class="d-flex justify-content-between">
                            <span>${agent.post_title}</span>
                            <small class="text-muted">${agent.agency_name || 'Indépendant'}</small>
                        </div>
                    </a>`
                ).join('');
                
                // Event listeners pour les clics
                resultsDiv.querySelectorAll('.dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.getElementById('agent_search').value = this.dataset.name;
                        document.getElementById('agent_id').value = this.dataset.id;
                        resultsDiv.classList.remove('show');
                    });
                });
            }
            
            resultsDiv.classList.add('show');
        }

        function updateDebugInfo(context) {
            document.getElementById('debug-content').textContent = JSON.stringify(context, null, 2);
        }

        // Gestion du formulaire
        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validation basique
            const nom = document.getElementById('nom').value;
            const prenom = document.getElementById('prenom').value;
            const agencyId = document.getElementById('agency_id').value;
            const agentId = document.getElementById('agent_id').value;
            
            if (!nom || !prenom || !agencyId || !agentId) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            // Ici on pourrait envoyer les données
            console.log('Données du formulaire:', new FormData(this));
            alert('Formulaire prêt à être envoyé (simulation)');
        });
    </script>
</body>
</html>
